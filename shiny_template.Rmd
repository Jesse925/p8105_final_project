---
title: "Don't do drugs! - Map of drug related death"
output: 
  flexdashboard::flex_dashboard:
    theme: flatly
    social: menu
    orientation: columns
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(flexdashboard)
library(leaflet)
library(tidyverse)
library(shiny)


drug_df = 
  read_csv("./data/Accidental_Drug_Related_Deaths_2012-2018.csv") %>%
  janitor::clean_names() %>% 
  mutate(
    date = as.character(date)
  ) %>% 
  separate(date, into = c("month", "day", "year"), sep = "/") %>% 
  mutate(
    year = unlist(strsplit(year, " "))[1],
    year = ifelse(is.na(month), NA, as.numeric(year)),
    day = as.numeric(day),
    month = factor(month.name[as.numeric(month)], levels = month.name),
    race = as.factor(race),
    sex = as.factor(sex)
  ) %>% 
  separate(injury_city_geo, into = c("injury_city", "injury_geo"), sep = "CT") %>% 
  separate(injury_geo, into = c("inj_lat", "inj_long"), sep = ",") %>% 
  mutate(
    inj_lat = as.numeric(str_remove(inj_lat, "\\(")),
    inj_long = as.numeric(str_remove(inj_long, "\\)")),
    injury_city = str_remove(injury_city, "\\,")
  ) %>% 
  select(-date_type) %>% 
  pivot_longer(
    heroin:any_opioid,
    names_to = "drug_name",
    values_to = "drug_use") %>% 
  drop_na(drug_use) %>% 
  select(-drug_use)

new_drug_df = 
  drug_df %>% 
  group_by(id) %>% 
  mutate(drug_name = as.factor(drug_name), 
         drug_name = sort(drug_name)) %>% 
  mutate(
    drug_names = paste(drug_name, collapse = ", "), 
    drug_number = length(drug_name)
  ) %>% 
  select(-drug_name) %>% distinct()
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r echo=FALSE}
# for chart A
# races = new_drug_df %>% distinct(race) %>% pull()

races = new_drug_df %>% pull(race) %>% levels()

selectInput(
  # give the input a `name`: "boro_choice" in case you need to access it later
  # in html doc, it's actually `class_id`
  "race_choice", 
  label = h3("Select race"),
  choices = races, selected = "White")

drug_numbers = new_drug_df %>% pull(drug_number) %>% as.factor() %>% levels()

selectInput(
  "drug_number_choice", 
  label = h3("Select the number of drug used"),
  choices = drug_numbers, selected = "3")
```

Column {data-width=650}
-----------------------------------------------------------------------

### Geolocation of injury city

```{r echo=FALSE, warning=FALSE}
renderLeaflet({
    # Use leaflet() here, and only include aspects of the map that
    # won't need to change dynamically (at least, not unless the
    # entire map is being torn down and recreated).
    new_drug_df %>% 
    filter(
      race == input[["race_choice"]], 
      drug_number == input$drug_number_choice
    ) %>% 
    leaflet() %>% addTiles() %>%
    addProviderTiles(providers$Esri.NatGeoWorldMap) %>% 
    addCircles(lat = ~inj_lat, lng = ~inj_long, radius = 5) %>% 
    addCircleMarkers(lat = ~inj_lat, lng = ~inj_long, radius = 5, popup = paste(new_drug_df$injury_city, new_drug_df$drug_names,  sep = ""))
  })
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}
drug_df %>% 
  group_by(id) %>% 
  summarise(number_of_drug_use = n()) %>% 
  ggplot() +
  geom_bar(aes(x = number_of_drug_use))
```

### Chart C

```{r}
new_drug_df %>% ggplot() +
  geom_bar(aes(x = drug_number))
```